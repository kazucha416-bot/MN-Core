# LM0の値セット
# 粒子0 
d set $lm0n0c0b0m0p0 28 000000000000000000000000000000000000000000000000000000000000000040000000000000004000000000000000400000000000000040000000000000003f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff0000000000000
# 粒子1
d set $lm0n0c0b0m0p1 28 00000000000000003ff00000000000003ff0000000000000000000000000000040000000000000004000000000000000400000000000000040000000000000003f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff0000000000000
# 粒子2
d set $lm0n0c0b0m0p2 28 3ff00000000000003ff00000000000000000000000000000000000000000000040000000000000004000000000000000400000000000000040000000000000003f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff0000000000000
# 粒子3
d set $lm0n0c0b0m0p3 28 3ff000000000000000000000000000003ff0000000000000000000000000000040000000000000004000000000000000400000000000000040000000000000003f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3f747ae147ae147b3ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff00000000000003ff0000000000000


# 速度の初期配置ひとつのPEに１粒子を配置
# 粒子０の速度
d set $ln0n0c0b0m0p0 4 3ff6fedb5036cee63fe24036f78584993fe0e0f20483e1ec0000000000000000
# 粒子１の速度
d set $ln0n0c0b0m0p1 4 bff184309c1ae6de3fd4bcc1f976fb67bff16a66c8d8744c0000000000000000
# 粒子２の速度
d set $ln0n0c0b0m0p2 4 bfb07ff40a6985753ff36463a89d1838bfd3db7140fb17bc0000000000000000
# 粒子３の速度
d set $ln0n0c0b0m0p3 4 bfd1caadcdd53ec0c000d9d7d15eccaf3febe1942daa928b0000000000000000

# lrの初期配置．面倒な計算は先に済ませて，値を入れておく
d set $lr80n0c0b0m0 8 40100000000000004010000000000000401000000000000040100000000000004010000000000000401000000000000040100000000000004010000000000000
# lsの初期配置．
d set $ls24n0c0b0m0 8 40380000000000004038000000000000403800000000000040380000000000004048000000000000404800000000000040480000000000004048000000000000
# [mslを使って相互作用を計算する]
# 座標を時計回りに回転させてls0vに格納．
msl $lm0v $ls0v
nop
# 元の座標 - 1回転させた座標 = lr0vに格納
dvadd $lm0v -$ls0v $lr0v
# lm0vの座標をもうひと回転
msl $ls0v $ls0v
nop
# 元の座標 - 2回転させた座標 = lr8vに格納
dvadd $lm0v -$ls0v $lr8v


# lrに格納された距離の差6ペアを二乗してr2を求める．SDMの3.6.9.11参照．
dvmulu $lr0v $lr0v $nowrite
dvfmad $lr0v $lr0v $mauf $lr[16,24,32,40]
dvmulu $lr8v $lr8v $nowrite
dvfmad $lr8v $lr8v $mauf $lr[18,26,34,42]

nop/2
# r^2の合計6ペアを格納
dvpassa $lr24v $nowrite
dvadd $lr16v $mauf $nowrite
dvadd $mauf $lr32v $lr40v
# r2iを求めていく
エネルギー
drsqrt $lr40v $ls8v
nop
# r~^-2がls8vに格納された．これをNR法により補正していく．
dvmulu $ls8v $ls8v $nowrite
dvfmad $ls8v $ls8v $mauf $ls8v
# NR法
nop
dvfmau $lr40v -$ls8v $lm8v $nowrite
dvfmad $lr40v -$ls8v $mauf $lr48v # lr48vに補正係数
nop
dvmulu $lr48v $ls8v $nowrite
dvfmad $lr48v $ls8v $mauf $lr56v # lr56vにr2iが入った

# r2i*r2iを計算
nop
dvmulu $lr56v $lr56v $nowrite
dvfmad $lr56v $lr56v $mauf $ls16v
# r6iを計算
nop
dvmulu $ls16v $lr56v $nowrite
dvfmad $ls16v $lr56v $mauf $lr64v
# r12iを計算
nop
dvmulu $lr64v $lr64v $nowrite
dvfmad $lr64v $lr64v $mauf $lr72v

# ep = ce12 * r12i - ce06 * r06i
dvpassa $lr80v $ls256v
nop
dvmulu $lr64v $ls256v $nowrite
dvfmad $lr64v $ls256v $mauf $ls256v
dvpassa $lr72v $ln256v
nop/2
dvfmau $lr88v $ln256v -$ls256v $nowrite
dvfmad $lr88v $ln256v $mauf $lm56v
d set $lm58n0c0b0m0p2 1 0000000000000000
d set $lm58n0c0b0m0p3 1 0000000000000000
nop/2
# エネルギーの値をL1BMに転送する．4つのアドレスの合計が全エネルギーになる．
dvpassa $lm58 $nowrite
dvadd $lm56 $mauf $nowrite
l1bmr4dfadd $mauf $lb0

d getd $lm0n0c0b0m0 32
d getd $ln0n0c0b0m0 32
d getd $lr0n0c0b0m0 64
d getd $ls0n0c0b0m0 32
d getd $lb0n0c0b0 4
